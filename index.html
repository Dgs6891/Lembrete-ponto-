<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Alerta Pro</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-add { background: var(--primary); color: white; margin-bottom: 10px; }
        .btn-test { background: #e2e8f0; color: #333; }
        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #f8fafc; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .del-btn { background: #ff4444; color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div class="card">
    <h2>‚è∞ Novo Lembrete</h2>
    
    <div class="input-group">
        <label>T√≠tulo (Ex: Entrada, Almo√ßo):</label>
        <input type="text" id="titulo" placeholder="Digite o nome do alerta">
        
        <label>Hor√°rio:</label>
        <input type="time" id="hora">
        
        <button class="btn-add" onclick="adicionar()">Salvar Lembrete</button>
        <button class="btn-test" onclick="testar()">üîî Testar Notifica√ß√£o Agora</button>
    </div>

    <ul id="lista"></ul>
</div>

<audio id="som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    let lembretes = JSON.parse(localStorage.getItem('lembretes')) || [];

    // Registrar o Service Worker de forma correta
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log("Service Worker Registrado!"));
    }

    function atualizarInterface() {
        const lista = document.getElementById('lista');
        lista.innerHTML = '';
        lembretes.forEach((item, i) => {
            lista.innerHTML += `<li><div><strong>${item.titulo}</strong><br>${item.hora}</div> 
            <button class="del-btn" onclick="remover(${i})">X</button></li>`;
        });
        localStorage.setItem('lembretes', JSON.stringify(lembretes));
    }

    async function testar() {
        const perm = await Notification.requestPermission();
        if (perm === 'granted') {
            dispararAlerta("Teste de Som", "Se voc√™ ouviu o barulho, est√° funcionando!");
        } else {
            alert("Voc√™ bloqueou as notifica√ß√µes. Ative nas configura√ß√µes do navegador.");
        }
    }

    function adicionar() {
        const t = document.getElementById('titulo').value;
        const h = document.getElementById('hora').value;
        if (!t || !h) return alert("Preencha t√≠tulo e hora!");
        
        lembretes.push({titulo: t, hora: h});
        atualizarInterface();
        Notification.requestPermission();
    }

    function remover(i) {
        lembretes.splice(i, 1);
        atualizarInterface();
    }

    function dispararAlerta(titulo, msg) {
        // Tenta tocar o som (precisa de intera√ß√£o pr√©via na p√°gina)
        const audio = document.getElementById('som');
        audio.play().catch(() => console.log("O navegador barrou o som autom√°tico."));

        if (Notification.permission === 'granted') {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification(titulo, {
                    body: msg,
                    icon: 'https://cdn-icons-png.flaticon.com/512/2693/2693507.png',
                    vibrate: [200, 100, 200],
                    badge: 'https://cdn-icons-png.flaticon.com/512/2693/2693507.png'
                });
            });
        }
    }

    // Loop de verifica√ß√£o
    setInterval(() => {
        const agora = new Date();
        const horaAtual = agora.getHours().toString().padStart(2, '0') + ':' + 
                          agora.getMinutes().toString().padStart(2, '0');
        
        lembretes.forEach(l => {
            if (l.hora === horaAtual && window.ultimo !== horaAtual + l.titulo) {
                dispararAlerta(l.titulo, "Est√° na hora!");
                window.ultimo = horaAtual + l.titulo;
            }
        });
    }, 1000);

    atualizarInterface();
</script>
</body>
</html>
